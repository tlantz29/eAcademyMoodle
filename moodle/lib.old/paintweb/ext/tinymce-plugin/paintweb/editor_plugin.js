(function(){var i=null;var k=null;var R=null;var H=null;var W=null;var a=10000;var V=null;var K=30000;var F=null;var c=false;var N=null;var D=null;var S=null;var X=false;var f=null;var B=false;var P=null;if(!window.tinymce){alert("It looks like the PaintWeb plugin for TinyMCE cannot run.TinyMCE was not detected!");return }if(!window.XMLHttpRequest||!window.getComputedStyle||!document.createElement("canvas").getContext){return }var A,E,C;var L=(function(){var n=navigator.userAgent.toLowerCase();A=window.opera||/\b(opera|presto)\b/.test(n);E=!A&&/\b(applewebkit|webkit)\b/.test(n);C=!A&&!E&&/\bgecko\b/.test(n);if(E){return true}if(C){var m=/\brv\:([^;\)\s]+)[;\)\s]/.exec(n);if(m&&m[1]){m=m[1].replace(/[^\d]+$/,"").split(".");if(m[0]==1&&m[1]<=9&&m[2]<1){return true}}}return false})();function Z(){if(window.PaintWeb){M();return }var m=D.getParam("paintweb_config"),n=m.tinymce.paintwebFolder+"paintweb.js";tinymce.ScriptLoader.load(n,M)}function M(){if(H){return }H=new PaintWeb();R=H.config;var n=D.getParam("paintweb_config"),m=D.getElement();pNode=N.parentNode,pwContainer=tinymce.DOM.create("div");pNode.insertBefore(pwContainer,m.nextSibling);if(!PaintWeb.baseFolder){PaintWeb.baseFolder=n.tinymce.paintwebFolder}n.imageLoad=S;n.guiPlaceholder=pwContainer;if(!n.lang){n.lang=D.getParam("language")}for(var o in n){R[o]=n[o]}R.tinymceEditor=D;H.init(I)}function I(m){if(k&&D){k.value=D.getLang("paintweb.overlayButton","Edit")}if(m.state!==PaintWeb.INIT_DONE){alert("PaintWeb initialization failed! "+m.errorMessage);H=null;S=null;D=null;return }P=window.pwlib;H.events.add("imageSave",O);H.events.add("imageSaveResult",h);if(W){H.events.add("viewportSizeChange",j)}Y(m)}function b(){c=true;H.imageSave()}function e(){d()}function O(n){if(R.tinymce.imageSaveDataURL){n.preventDefault();var m=X?"-":D.dom.getAttrib(S,"src");H.events.dispatch(new P.appEvent.imageSaveResult(true,m,n.dataURL))}else{if(W){if(V){clearTimeout(V);V=null}W.firstChild.innerHTML=D.getLang("paintweb.statusSavingImage","Saving image...")}}}function h(m){if(!S){return }if(W){if(m.successful){W.firstChild.innerHTML=D.getLang("paintweb.statusImageSaved","Image save was succesful!")}else{W.firstChild.innerHTML=D.getLang("paintweb.statusImageSaveFailed","Image save failed!")}if(V){clearTimeout(V)}V=setTimeout(J,a)}if(m.successful){B=true;if(m.urlNew){f=m.urlNew}if(c){c=false;d()}}}function J(){if(!W){return }V=null;W.firstChild.innerHTML=D.getLang("paintweb.statusImageEditing","You are editing an image from TinyMCE.")}function j(m){tinymce.DOM.setStyle(W,"width",m.width)}function T(){if(!Q(S)){S=null;return false}if(F){clearTimeout(F);F=null}var n=function(){if(k&&k.parentNode){k.value=D.getLang("paintweb.overlayLoading","Loading PaintWeb...")}if(H){H.imageLoad(S);Y()}else{Z()}};var p=function(){tinymce.dom.Event.remove(S,"load",p);X=false;n()};var o=D.dom.getAttrib(S,"src");if(o.substr(0,5)==="data:"){X=true}else{X=false}var m=X&&L?D.getParam("paintweb_config"):null;if(m&&m.tinymce.imageDataURLfilter){tinymce.util.XHR.send({url:m.tinymce.imageDataURLfilter,content_type:"application/x-www-form-urlencoded",data:"url=-&dataURL="+encodeURIComponent(o),error:function(){if(window.console&&console.log){console.log("TinyMCE.PaintWeb: failed to preload image data URL!")}n()},success:function(q){if(!q){n();return }q=tinymce.util.JSON.parse(q);if(!q||!q.successful||!q.urlNew){n();return }f=S.src;tinymce.dom.Event.add(S,"load",p);D.dom.setAttrib(S,"src",q.urlNew)}})}else{n()}o=null;return true}function U(p,m,r,s,t){p=parseInt(p)||0;m=parseInt(m)||0;if(!p||!m){return }var n=tinymce.DOM.create("canvas",{width:p,height:m}),o=n.getContext("2d");if(r){o.fillStyle=r;o.fillRect(0,0,p,m)}D.execCommand("mceInsertContent",false,'<img id="paintwebNewImage">');var q=D.dom.get("paintwebNewImage");if(!q||q.id!=="paintwebNewImage"||q.nodeName.toLowerCase()!=="img"){return }if(s){D.dom.setAttrib(q,"alt",s)}if(t){D.dom.setAttrib(q,"title",t)}q.src=n.toDataURL();q.setAttribute("mce_src",q.src);q.removeAttribute("id");S=q;n=null;o=null;T()}function Y(n){var m=null;if(R.tinymce.syncViewportSize){m=tinymce.DOM.getRect(D.getContentAreaContainer())}tinymce.DOM.setStyle(N,"display","none");R.tinymceEditor=D;if(!n||n.type!=="appInit"){H.gui.show()}if(m&&m.w&&m.h){H.gui.resizeTo(m.w+"px",m.h+"px")}if(W){J();var o=R.guiPlaceholder;if(!W.parentNode){o.parentNode.insertBefore(W,o)}}}function d(){H.gui.hide();if(k&&D){k.value=D.getLang("paintweb.overlayButton","Edit")}if(W&&W.parentNode){N.parentNode.removeChild(W)}if(f){if(f.substr(0,5)!=="data:"){D.dom.setAttrib(S,"src",f)}else{S.src=f;if(S.hasAttribute("mce_src")){S.setAttribute("mce_src",f)}}f=null}else{if(!X&&B){var n=D.dom.getAttrib(S,"src"),m=(new Date()).getMilliseconds()*Math.round(Math.random()*100);if(n.indexOf("?")===-1){n+="?"+m}else{if(/\?[0-9]+$/.test(n)){n=n.replace(/\?[0-9]+$/,"?"+m)}else{if(/&[0-9]+$/.test(n)){n=n.replace(/&[0-9]+$/,"&"+m)}else{n+="&"+m}}}D.dom.setAttrib(S,"src",n)}}N.style.display="";S=null;B=false;D.focus();if(!F){F=setTimeout(l,K)}}function l(){if(H){H.destroy();var m=R.guiPlaceholder.parentNode;m.removeChild(R.guiPlaceholder);H=null;R=null;F=null}}function g(){if(S){return }var o=this.selection.getNode(),m=o.nodeName.toLowerCase();if(m!=="img"&&k&&k.parentNode&&k._targetImage){o=k._targetImage;m=o.nodeName.toLowerCase()}D=this;N=this.getContainer();S=o;if(!T()&&m!=="img"){this.windowManager.open({file:i+"/newimage.html",width:350+parseInt(this.getLang("paintweb.dlg_delta_width",0)),height:200+parseInt(this.getLang("paintweb.dlg_delta_height",0)),inline:1},{plugin_url:i,newImageFn:U})}}function Q(r){if(!r){return false}var m=r.src;if(r.nodeName.toLowerCase()!=="img"||!m){return false}var q=m.indexOf(":"),p=m.substr(0,q+1).toLowerCase();if(p==="data:"){return true}if(p!=="http:"&&p!=="https:"){return false}var o=m.replace(/^https?:\/\//i,"");q=o.indexOf("/");if(q>-1){o=o.substr(0,q)}if(o!==window.location.host){return false}return true}function G(n){if(!n||!n.getDoc){return }var q,m,p;if(k){if(k.parentNode){p=k.parentNode;p.removeChild(k)}k._targetImage=null}q=n.getDoc();if(!q||!q.getElementsByClassName){return }m=q.getElementsByClassName(k.className);for(var o=0;o<m.length;o++){p=m[o].parentNode;p.removeChild(m[o])}}tinymce.PluginManager.requireLangPack("paintweb");tinymce.create("tinymce.plugins.paintweb",{init:function(m,o){var p=this;i=o;m.addCommand("paintwebEdit",g,m);m.addButton("paintwebEdit",{title:"paintweb.toolbarButton",cmd:"paintwebEdit",image:i+"/img/paintweb2.gif"});if(A){m.onKeyUp.add(this.edNodeChange);m.onMouseUp.add(this.edNodeChange)}else{m.onNodeChange.add(this.edNodeChange)}var n=m.getParam("paintweb_config")||{};if(!n.tinymce){n.tinymce={}}if(n.tinymce.contextMenuItem&&m.plugins.contextmenu){m.plugins.contextmenu.onContextMenu.add(this.pluginContextMenu)}m.onSubmit.add(this.edSubmit);if(n.tinymce.overlayButton){m.onPreProcess.add(G);m.onBeforeGetContent.add(G);m.onRemove.add(G);m.onInit.add(function(){G(m);m.onKeyDown.addToTop(G);m.onMouseDown.addToTop(p.overlayButtonMouseDown)});k=tinymce.DOM.create("input",{type:"button","class":"paintweb_tinymce_overlayButton",style:"position:absolute",value:m.getLang("paintweb.overlayButton","Edit")})}if(n.tinymce.dblclickHandler){m.onDblClick.add(this.edDblClick)}if(n.tinymce.pluginBar){W=tinymce.DOM.create("div",{"class":"paintweb_tinymce_status",style:"display:none"});var r=tinymce.DOM.create("input",{type:"button","class":"paintweb_tinymce_save",title:m.getLang("paintweb.imageSaveButtonTitle","Save the image and return to TinyMCE."),value:m.getLang("paintweb.imageSaveButton","Save")});r.addEventListener("click",b,false);var q=tinymce.DOM.create("input",{type:"button","class":"paintweb_tinymce_cancel",title:m.getLang("paintweb.cancelEditButtonTitle","Cancel image edits and return to TinyMCE."),value:m.getLang("paintweb.cancelEditButton","Cancel")});q.addEventListener("click",e,false);var s=tinymce.DOM.create("span");W.appendChild(s);W.appendChild(r);W.appendChild(q)}},edNodeChange:function(o){var m=o.controlManager,u=o.selection.getNode();if(!u||k&&k._targetImage&&u&&u.className===k.className){return }var s=!Q(u),p=null;if(u.nodeName.toLowerCase()==="img"&&s){m.setDisabled("paintwebEdit",true);m.setActive("paintwebEdit",false)}else{m.setDisabled("paintwebEdit",false);m.setActive("paintwebEdit",!s)}if(!k){return }if(!s){var r=5,t=5,q=null;if(u.parentNode.nodeName.toLowerCase()==="a"){p=u.parentNode.parentNode;q=u.parentNode.nextSibling}else{p=u.parentNode;q=u.nextSibling}k._targetImage=u;o.dom.setStyles(k,{top:(u.offsetTop+r)+"px",left:(u.offsetLeft+t)+"px"});k.value=o.getLang("paintweb.overlayButton","Edit");p.insertBefore(k,q)}else{if(k._targetImage){k._targetImage=null}}},overlayButtonMouseDown:function(m,n){if(!S&&k&&n.target&&n.target.className===k.className&&k._targetImage){D=m;N=m.getContainer();S=k._targetImage;T()}else{if(n.target&&n.target.nodeName.toLowerCase()!=="img"){G(m)}}},edDblClick:function(m,n){if(!S&&Q(n.target)){D=m;N=m.getContainer();S=n.target;n.target.focus();T()}},edSubmit:function(m,n){if(!S||!H){return }if(!H.image.modified){d();m.save();return }n.preventDefault();if(W){var o=m.getLang("paintweb.submitUnsaved","The image is not saved! You cannot submit the form. Please save the image changes, or cancel image editing, then try again.");W.firstChild.innerHTML=o;if(V){clearTimeout(V)}V=setTimeout(J,a);W.tabIndex=5;W.focus();W.tabIndex=-1}if(typeof R.tinymce.onSubmitUnsaved==="function"){R.tinymce.onSubmitUnsaved(n,m,H)}},pluginContextMenu:function(n,o,m){if(Q(m)){o.add({title:"paintweb.contextMenuEdit",cmd:"paintwebEdit",image:i+"/img/paintweb2.gif"})}},getInfo:function(){return{longname:"PaintWeb - online painting application",author:"Mihai Åžucan",authorurl:"http://www.robodesign.ro/mihai",infourl:"http://code.google.com/p/paintweb",version:"0.9"}}});tinymce.PluginManager.add("paintweb",tinymce.plugins.paintweb)})();